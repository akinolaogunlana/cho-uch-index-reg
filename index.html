<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CHO INDEXING FORM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <!-- PDF and ZIP libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.6.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* Flash animation for the registration fee warning */
    @keyframes flashAlert {
      0% { background-color: #ffdddd; }
      50% { background-color: #ffe5e5; }
      100% { background-color: #ffdddd; }
    }
    .flash-alert {
      animation: flashAlert 1s infinite;
    }

    /* Responsive alert styling */
    #feeAlert {
      font-size: 1rem;
      line-height: 1.4;
    }
    @media screen and (max-width: 600px) {
      #feeAlert {
        font-size: 1.3rem;
        padding: 20px;
      }
      #feeAlert span {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>

<h2>CHO INDEXING DATA COLLECTION</h2>

<form id="indexForm" enctype="multipart/form-data">

  <input name="surname" placeholder="SURNAME" required>
  <input name="firstname" placeholder="FIRSTNAME" required>
  <input name="othernames" placeholder="OTHERNAMES">

  <label>PASSPORT (JPG / PNG, Max 5MB)</label>
  <input type="file" id="passport" accept="image/jpeg,image/png" required>

  <input name="cadre" value="CHO" readonly>

  <select name="gender" required>
    <option value="">SELECT GENDER</option>
    <option value="MALE">MALE</option>
    <option value="FEMALE">FEMALE</option>
  </select>

  <input name="bloodgroup" placeholder="BLOOD GROUP">
  <input name="state" placeholder="STATE">
  <input name="lga_city_town" placeholder="LGA / CITY/TOWN">

  <label>DATE OF BIRTH</label>
  <input type="date" name="dob" required>

  <select name="olevel_type" required>
    <option value="">SELECT O-LEVEL TYPE</option>
    <option value="WAEC">WAEC</option>
    <option value="NECO">NECO</option>
    <option value="WAEC / WAEC">WAEC / WAEC</option>
    <option value="NECO / NECO">NECO / NECO</option>
    <option value="NECO / WAEC">NECO / WAEC</option>
  </select>

  <input name="olevel_year" placeholder="O-LEVEL YEAR(S)">
  <input name="olevel_exam" placeholder="O-LEVEL EXAM NUMBER">

  <input name="alevel_type" placeholder="A-LEVEL TYPE">
  <input name="alevel_year" placeholder="A-LEVEL YEAR">
  <input name="pro_cert" placeholder="PROFESSIONAL CERTIFICATE NUMBER">

  <input id="engGrade" placeholder="ENGLISH GRADE" required>
  <select id="engBody"><option>WAEC</option><option>NECO</option></select>

  <input id="mathGrade" placeholder="MATHEMATICS GRADE" required>
  <select id="mathBody"><option>WAEC</option><option>NECO</option></select>

  <input id="bioGrade" placeholder="BIOLOGY GRADE">
  <select id="bioBody"><option>WAEC</option><option>NECO</option></select>

  <input id="chemGrade" placeholder="CHEMISTRY GRADE">
  <select id="chemBody"><option>WAEC</option><option>NECO</option></select>

  <input id="phyGrade" placeholder="PHYSICS GRADE">
  <select id="phyBody"><option>WAEC</option><option>NECO</option></select>

  <input name="remarks" placeholder="REMARKS">

  <button type="submit">SUBMIT</button>
  <button type="button" id="downloadPDFBtn" style="margin-top:10px; background:#4caf50; color:#fff;">Download My Submission PDF</button>
  <button type="button" id="adminLoginBtn" style="margin-top:10px; background:#333; color:#fff;">Admin Login</button>
  <button type="button" id="downloadZipBtn" style="margin-top:10px; display:none;">Download All Passports (ZIP)</button>

  <!-- Passport preview -->
  <div id="previewContainer" style="margin:15px 0;text-align:center;"></div>

</form>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const SHEETBEST_URL = "https://api.sheetbest.com/sheets/ceb9eddc-af9a-473a-9a32-f52c21c7f72b";
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpsbwjw83/image/upload";
  const CLOUDINARY_PRESET = "cho_passports";
  const ADMIN_PASSWORD = "CHO@2026Secure!";

  const form = document.getElementById("indexForm");
  const submitBtn = form.querySelector("button[type='submit']");
  const downloadPDFBtn = document.getElementById("downloadPDFBtn");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const downloadZipBtn = document.getElementById("downloadZipBtn");
  const previewContainer = document.getElementById("previewContainer");

  let passportDataUrl = "";

  // Passport preview
  document.getElementById("passport").addEventListener("change", function () {
    previewContainer.innerHTML = "";
    const file = this.files[0];
    if (file) {
      if (!["image/jpeg","image/png"].includes(file.type)) {
        alert("Only JPG and PNG images allowed.");
        this.value = "";
        return;
      }
      if (file.size > 5*1024*1024) {
        alert("Image too large (max 5MB).");
        this.value = "";
        return;
      }
      const img = document.createElement("img");
      img.style.maxWidth = "150px";
      img.style.borderRadius = "8px";
      img.style.boxShadow = "0 4px 15px rgba(0,0,0,0.15)";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.getContext("2d").drawImage(img,0,0);
        passportDataUrl = canvas.toDataURL("image/jpeg");
      };
      img.src = URL.createObjectURL(file);
      previewContainer.appendChild(img);
    }
  });

  // PDF download
  downloadPDFBtn.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    doc.setFontSize(18);
    doc.text("CHO Indexing Form",105,y,{align:"center"});
    y+=10;
    if(passportDataUrl){
      doc.addImage(passportDataUrl,"JPEG",80,y,50,50);
      y+=60;
    }
    doc.setFontSize(12);
    const fields = [
      ["SURNAME", form.surname.value.toUpperCase()],
      ["FIRSTNAME", form.firstname.value.toUpperCase()],
      ["OTHERNAMES", form.othernames.value.toUpperCase()],
      ["CADRE", form.cadre.value],
      ["GENDER", form.gender.value],
      ["BLOOD GROUP", form.bloodgroup.value],
      ["STATE", form.state.value],
      ["LGA / CITY/TOWN", form.lga_city_town.value],
      ["DATE OF BIRTH", form.dob.value],
      ["O-LEVEL TYPE", form.olevel_type.value],
      ["O-LEVEL YEAR", form.olevel_year.value],
      ["O-LEVEL EXAM NO.", form.olevel_exam.value],
      ["A-LEVEL TYPE", form.alevel_type.value],
      ["A-LEVEL YEAR", form.alevel_year.value],
      ["PROFESSIONAL CERT. NO.", form.pro_cert.value],
      ["ENGLISH", `${document.getElementById("engGrade").value} (${document.getElementById("engBody").value})`],
      ["MATHEMATICS", `${document.getElementById("mathGrade").value} (${document.getElementById("mathBody").value})`],
      ["BIOLOGY", document.getElementById("bioGrade").value ? `${document.getElementById("bioGrade").value} (${document.getElementById("bioBody").value})` : ""],
      ["CHEMISTRY", document.getElementById("chemGrade").value ? `${document.getElementById("chemGrade").value} (${document.getElementById("chemBody").value})` : ""],
      ["PHYSICS", document.getElementById("phyGrade").value ? `${document.getElementById("phyGrade").value} (${document.getElementById("phyBody").value})` : ""],
      ["REMARKS", form.remarks.value]
    ];
    fields.forEach(([label,value])=>{
      doc.text(`${label}: ${value}`,20,y);
      y+=8;
      if(y>280){doc.addPage();y=20;}
    });
    doc.save(`CHO_Form_${form.surname.value}_${form.firstname.value}.pdf`);
  });

  // Admin login & ZIP download code remain unchanged

  // Form submission
  form.addEventListener("submit", async function(e){
    e.preventDefault();
    submitBtn.disabled=true;
    submitBtn.innerText="Uploading passport...";
    try{
      const file = document.getElementById("passport").files[0];
      if(!file) throw "Passport required";
      if(!["image/jpeg","image/png"].includes(file.type)) throw "Only JPG/PNG allowed";
      if(file.size>5*1024*1024) throw "Max image size 5MB";

      const cloudForm = new FormData();
      cloudForm.append("file",file);
      cloudForm.append("upload_preset",CLOUDINARY_PRESET);
      const cloudRes = await fetch(CLOUDINARY_URL,{method:"POST",body:cloudForm});
      if(!cloudRes.ok) throw "Cloudinary upload failed";
      const cloudData = await cloudRes.json();
      if(!cloudData.secure_url) throw "Upload error";

      submitBtn.innerText="Saving data...";
      const data=[{
        SURNAME: form.surname.value.trim().toUpperCase(),
        FIRSTNAME: form.firstname.value.trim().toUpperCase(),
        OTHERNAMES: form.othernames.value.trim().toUpperCase(),
        PASSPORT: cloudData.secure_url,
        CADRE: form.cadre.value,
        GENDER: form.gender.value,
        BLOOD_GROUP: form.bloodgroup.value,
        STATE: form.state.value,
        LGA_CITY_TOWN: form.lga_city_town.value,
        DATE_OF_BIRTH: form.dob.value,
        OLEVEL_TYPE: form.olevel_type.value,
        OLEVEL_YEAR: form.olevel_year.value,
        OLEVEL_EXAM_NUMBER: form.olevel_exam.value,
        ALEVEL_TYPE: form.alevel_type.value,
        ALEVEL_YEAR: form.alevel_year.value,
        PROFESSIONAL_CERTIFICATE_NUMBER: form.pro_cert.value,
        ENGLISH: `${engGrade.value} (${engBody.value})`,
        MATHEMATICS: `${mathGrade.value} (${mathBody.value})`,
        BIOLOGY: bioGrade.value?`${bioGrade.value} (${bioBody.value})`:"",
        CHEMISTRY: chemGrade.value?`${chemGrade.value} (${chemBody.value})`:"",
        PHYSICS: phyGrade.value?`${phyGrade.value} (${phyBody.value})`:"",
        REMARKS: form.remarks.value
      }];
      const resSheet = await fetch(SHEETBEST_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
      });
      if(!resSheet.ok) throw "Sheet save failed";

      // Success screen with mobile-friendly flash alert
      form.innerHTML = `
        <div style="text-align:center;padding:40px; max-width:500px; margin:auto;">
          <div id="feeAlert" class="flash-alert" style="color:#a94442; border:1px solid #f5c6cb; padding:15px; border-radius:8px; margin-bottom:20px; position:relative;">
            ⚠️ Your information will be erased if you do not pay your registration fee. <br>
            Admin will only accept your information after receiving your payment.
            <span id="closeAlert" style="position:absolute; top:5px; right:10px; cursor:pointer; font-weight:bold;">&times;</span>
          </div>
          <h2 style="color:#28a745">✅ Submission Successful</h2>
          <p>Your information has been saved successfully.</p>
          <button onclick="location.reload()" style="margin-top:20px;">Submit Another</button>
        </div>
      `;

      document.getElementById("closeAlert").addEventListener("click", () => {
        document.getElementById("feeAlert").style.display = "none";
      });

    }catch(err){
      alert(err);
      submitBtn.disabled=false;
      submitBtn.innerText="SUBMIT";
      console.error(err);
    }
  });

});
</script>

</body>
</html>