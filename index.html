<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CHO INDEXING FORM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.6.1/jsPDF.umd.min.js"></script>
</head>
<body>

<h2>CHO INDEXING DATA COLLECTION</h2>

<!-- ðŸ” REVIEW / EDIT -->
<div style="border:1px solid #ccc;padding:15px;margin-bottom:20px">
  <h3>Review / Edit My Submission</h3>
  <input id="searchSurname" placeholder="SURNAME">
  <select id="searchBlood">
    <option value="">BLOOD GROUP</option>
    <option>A+</option><option>A-</option>
    <option>B+</option><option>B-</option>
    <option>AB+</option><option>AB-</option>
    <option>O+</option><option>O-</option>
  </select>
  <select id="searchOlevel">
    <option value="">O-LEVEL TYPE</option>
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
    <option>WAEC / NECO</option>
    <option>WAEC / WAEC</option>
    <option>NECO / NECO</option>
    <option>NABTEB / WAEC</option>
  </select>
  <button id="searchBtn">Search</button>
  <p id="searchMsg" style="color:red"></p>
</div>

<form id="indexForm">

<input name="surname" placeholder="SURNAME" required>
<input name="firstname" placeholder="FIRSTNAME" required>
<input name="othernames" placeholder="OTHERNAMES">

<label>PASSPORT (Upload only if changing)</label>
<input type="file" id="passport" accept="image/jpeg,image/png">

<input name="cadre" value="CHO" readonly>

<select name="gender" required>
  <option value="">SELECT GENDER</option>
  <option>MALE</option>
  <option>FEMALE</option>
</select>

<select name="bloodgroup" required>
  <option value="">SELECT BLOOD GROUP</option>
  <option>A+</option><option>A-</option>
  <option>B+</option><option>B-</option>
  <option>AB+</option><option>AB-</option>
  <option>O+</option><option>O-</option>
</select>

<input name="state" placeholder="STATE">
<input name="lga_city_town" placeholder="LGA / CITY/TOWN">

<label>DATE OF BIRTH</label>
<input type="date" name="dob" required>

<select name="olevel_type" required>
  <option value="">SELECT O-LEVEL TYPE</option>
  <option>WAEC</option>
  <option>NECO</option>
  <option>NABTEB</option>
  <option>WAEC / NECO</option>
  <option>WAEC / WAEC</option>
  <option>NECO / NECO</option>
  <option>NABTEB / WAEC</option>
</select>

<input name="olevel_year" placeholder="O-LEVEL YEAR(S)">
<input name="olevel_exam" placeholder="O-LEVEL EXAM NUMBER">

<input name="remarks" placeholder="REMARKS">

<button type="submit">SAVE / UPDATE</button>
<button type="button" id="downloadPDFBtn" style="background:#4caf50;color:#fff">
Download Slip (PDF)
</button>

</form>

<script>
const SHEETBEST_URL = "https://api.sheetbest.com/sheets/ceb9eddc-af9a-473a-9a32-f52c21c7f72b";
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpsbwjw83/image/upload";
const CLOUDINARY_PRESET = "cho_passports";

let currentRowId = null;
let passportURL = "";

searchBtn.onclick = async () => {
  const s = searchSurname.value.trim().toUpperCase();
  const b = searchBlood.value;
  const o = searchOlevel.value;
  searchMsg.textContent = "";

  if (!s || !b || !o) {
    searchMsg.textContent = "âš ï¸ Fill all search fields";
    return;
  }

  const res = await fetch(SHEETBEST_URL);
  const data = await res.json();

  const record = data.find(r =>
    r.SURNAME === s &&
    r.BLOOD_GROUP === b &&
    r.OLEVEL_TYPE === o
  );

  if (!record) {
    searchMsg.textContent = "âŒ Record not found";
    return;
  }

  currentRowId = record.id;
  passportURL = record.PASSPORT;

  for (const key in record) {
    if (indexForm[key]) indexForm[key].value = record[key];
  }

  alert("âœ… Record loaded. You can now edit.");
};

indexForm.onsubmit = async e => {
  e.preventDefault();

  let newPassport = passportURL;
  if (passport.files[0]) {
    const fd = new FormData();
    fd.append("file", passport.files[0]);
    fd.append("upload_preset", CLOUDINARY_PRESET);
    const up = await fetch(CLOUDINARY_URL, { method: "POST", body: fd });
    newPassport = (await up.json()).secure_url;
  }

  const payload = {
    SURNAME: surname.value.toUpperCase(),
    FIRSTNAME: firstname.value.toUpperCase(),
    OTHERNAMES: othernames.value.toUpperCase(),
    PASSPORT: newPassport,
    CADRE: "CHO",
    GENDER: gender.value,
    BLOOD_GROUP: bloodgroup.value,
    STATE: state.value,
    LGA_CITY_TOWN: lga_city_town.value,
    DATE_OF_BIRTH: dob.value,
    OLEVEL_TYPE: olevel_type.value,
    OLEVEL_YEAR: olevel_year.value,
    OLEVEL_EXAM_NUMBER: olevel_exam.value,
    REMARKS: remarks.value
  };

  const method = currentRowId ? "PUT" : "POST";
  const url = currentRowId ? `${SHEETBEST_URL}/${currentRowId}` : SHEETBEST_URL;

  await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify([payload])
  });

  alert("âœ… Information saved successfully");
};

downloadPDFBtn.onclick = () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 20;
  pdf.text("CHO INDEXING SLIP", 105, y, { align: "center" });
  y += 15;

  [...indexForm.elements].forEach(el => {
    if (el.name && el.type !== "file") {
      pdf.text(`${el.name.toUpperCase()}: ${el.value}`, 20, y);
      y += 8;
    }
  });

  pdf.save(`CHO_SLIP_${surname.value}_${bloodgroup.value}_${olevel_type.value}.pdf`);
};
</script>

</body>
</html>