<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CHO INDEXING ‚Äì RETRIEVE, EDIT & SLIP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.6.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    form {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,.1);
    }
    input, select, button, label {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      box-sizing: border-box;
    }
    button {
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    #retrieveBtn { background: #1e88e5; color: #fff; }
    #updateBtn { background: #2ecc71; color: #fff; }
    #downloadPDFBtn { background: #4caf50; color: #fff; display: none; }
    #previewContainer img { max-width: 120px; border-radius: 8px; margin-top: 10px; }
    hr { margin: 25px 0; }
  </style>
</head>

<body>

<h2>CHO INDEXING ‚Äì RETRIEVE & CORRECT DATA</h2>

<form id="indexForm">

  <!-- üîê RETRIEVAL SECTION -->
  <input name="surname" placeholder="SURNAME" required>
  <select name="bloodgroup" required>
    <option value="">SELECT BLOOD GROUP</option>
    <option>A+</option><option>A-</option>
    <option>B+</option><option>B-</option>
    <option>AB+</option><option>AB-</option>
    <option>O+</option><option>O-</option>
  </select>
  <select name="olevel_type" required>
    <option value="">SELECT O-LEVEL TYPE</option>
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
    <option>WAEC / WAEC</option>
    <option>NECO / NECO</option>
    <option>NABTEB / NABTEB</option>
    <option>WAEC / NECO</option>
    <option>NABTEB / WAEC</option>
    <option>NABTEB / NECO</option>
  </select>
  <button type="button" id="retrieveBtn">üîç RETRIEVE MY RECORD</button>

  <hr>

  <!-- ‚úèÔ∏è EDITABLE SECTION -->
  <input name="firstname" placeholder="FIRSTNAME">
  <input name="othernames" placeholder="OTHERNAMES">

  <select name="gender">
    <option value="">SELECT GENDER</option>
    <option>MALE</option>
    <option>FEMALE</option>
  </select>

  <input name="state" placeholder="STATE">
  <input name="lga_city_town" placeholder="LGA / CITY/TOWN">

  <label>DATE OF BIRTH</label>
  <input type="date" name="dob">

  <!-- Passport Upload -->
  <label>PASSPORT (JPG/PNG, Max 5MB)</label>
  <input type="file" id="passport" accept="image/jpeg,image/png">
  <div id="previewContainer"></div>

  <input name="olevel_year" placeholder="O-LEVEL YEAR(S)">
  <input name="olevel_exam" placeholder="O-LEVEL EXAM NUMBER">
  <input name="alevel_type" placeholder="A-LEVEL TYPE">
  <input name="alevel_year" placeholder="A-LEVEL YEAR">

  <input id="engGrade" placeholder="ENGLISH GRADE">
  <select id="engBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>

  <input id="mathGrade" placeholder="MATHEMATICS GRADE">
  <select id="mathBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>

  <input id="bioGrade" placeholder="BIOLOGY GRADE">
  <select id="bioBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>

  <input id="chemGrade" placeholder="CHEMISTRY GRADE">
  <select id="chemBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>

  <input id="phyGrade" placeholder="PHYSICS GRADE">
  <select id="phyBody"><option>WAEC</option><option>NECO</option><option>NABTEB</option></select>

  <input name="remarks" placeholder="REMARKS">

  <button type="submit" id="updateBtn" disabled>‚úÖ UPDATE MY INFORMATION</button>
  <button type="button" id="downloadPDFBtn">üìÑ DOWNLOAD MY SLIP (PDF)</button>

</form>

<script>
document.addEventListener("DOMContentLoaded", () => {

const SHEETBEST_URL = "https://api.sheetbest.com/sheets/ceb9eddc-af9a-473a-9a32-f52c21c7f72b";
const form = document.getElementById("indexForm");
const retrieveBtn = document.getElementById("retrieveBtn");
const updateBtn = document.getElementById("updateBtn");
const downloadPDFBtn = document.getElementById("downloadPDFBtn");
const passportInput = document.getElementById("passport");
const previewContainer = document.getElementById("previewContainer");

let recordId = null;
let recordData = null;
let passportDataUrl = "";

// Format DOB
function formatDOB(d){
  if(!d) return "";
  const x = new Date(d);
  return `${String(x.getDate()).padStart(2,"0")}/${String(x.getMonth()+1).padStart(2,"0")}/${x.getFullYear()}`;
}

// ---------------- PASSPORT PREVIEW ----------------
passportInput.addEventListener("change", () => {
  previewContainer.innerHTML = "";
  const file = passportInput.files[0];
  if(!file) return;

  if(!["image/jpeg","image/png"].includes(file.type)){ alert("Only JPG/PNG allowed"); passportInput.value=""; return; }
  if(file.size>5*1024*1024){ alert("Max 5MB"); passportInput.value=""; return; }

  const img = document.createElement("img");
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    const canvas = document.createElement("canvas");
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    canvas.getContext("2d").drawImage(img,0,0);
    passportDataUrl = canvas.toDataURL("image/jpeg");
  };
  previewContainer.appendChild(img);
});

// ---------------- RETRIEVE ----------------
retrieveBtn.onclick = async () => {
  const surname = form.surname.value.trim().toUpperCase();
  const blood = form.bloodgroup.value;
  const olevel = form.olevel_type.value;

  if(!surname || !blood || !olevel){ alert("Complete all retrieval fields"); return; }

  try{
    const res = await fetch(SHEETBEST_URL);
    const data = await res.json();

    const found = data.find(r =>
      r.SURNAME.toUpperCase() === surname &&
      r.BLOOD_GROUP === blood &&
      r.OLEVEL_TYPE === olevel
    );

    if(!found){ alert("‚ùå Record not found"); return; }

    recordId = found._id || found.id;
    recordData = found;

    // Lock retrieval fields
    form.surname.disabled = true;
    form.bloodgroup.disabled = true;
    form.olevel_type.disabled = true;

    // Populate form fields
    const fields = ["firstname","othernames","gender","state","lga_city_town","dob","olevel_year","olevel_exam","alevel_type","alevel_year","remarks"];
    fields.forEach(f => { if(form[f] && found[f.toUpperCase()]) form[f].value = found[f.toUpperCase()]; });

    // Populate grades
    ["ENGLISH","MATHEMATICS","BIOLOGY","CHEMISTRY","PHYSICS"].forEach(sub => {
      if(found[sub]){
        const [v,b] = found[sub].split(" (");
        if(sub==="ENGLISH"){ form.engGrade.value=v; if(b) form.engBody.value=b.replace(")",""); }
        if(sub==="MATHEMATICS"){ form.mathGrade.value=v; if(b) form.mathBody.value=b.replace(")",""); }
        if(sub==="BIOLOGY"){ form.bioGrade.value=v; if(b) form.bioBody.value=b.replace(")",""); }
        if(sub==="CHEMISTRY"){ form.chemGrade.value=v; if(b) form.chemBody.value=b.replace(")",""); }
        if(sub==="PHYSICS"){ form.phyGrade.value=v; if(b) form.phyBody.value=b.replace(")",""); }
      }
    });

    updateBtn.disabled = false;
    downloadPDFBtn.style.display = "block";

    // Show passport if exists
    if(found.PASSPORT){
      passportDataUrl = found.PASSPORT;
      const img = document.createElement("img");
      img.src = passportDataUrl;
      previewContainer.innerHTML=""; previewContainer.appendChild(img);
    }

    alert("‚úÖ Record retrieved successfully");

  }catch(err){ console.error(err); alert("Error retrieving record."); }
};

// ---------------- UPDATE ----------------
form.onsubmit = async e => {
  e.preventDefault();
  if(!recordId) return;

  const payload = {
    FIRSTNAME: form.firstname.value,
    OTHERNAMES: form.othernames.value,
    GENDER: form.gender.value,
    STATE: form.state.value,
    LGA_CITY_TOWN: form.lga_city_town.value,
    DATE_OF_BIRTH: formatDOB(form.dob.value),
    OLEVEL_YEAR: form.olevel_year.value,
    OLEVEL_EXAM_NUMBER: form.olevel_exam.value,
    ALEVEL_TYPE: form.alevel_type.value,
    ALEVEL_YEAR: form.alevel_year.value,
    ENGLISH: `${form.engGrade.value} (${form.engBody.value})`,
    MATHEMATICS: `${form.mathGrade.value} (${form.mathBody.value})`,
    BIOLOGY: form.bioGrade.value ? `${form.bioGrade.value} (${form.bioBody.value})` : "",
    CHEMISTRY: form.chemGrade.value ? `${form.chemGrade.value} (${form.chemBody.value})` : "",
    PHYSICS: form.phyGrade.value ? `${form.phyGrade.value} (${form.phyBody.value})` : "",
    REMARKS: form.remarks.value,
    PASSPORT: passportDataUrl
  };

  try{
    await fetch(`${SHEETBEST_URL}/${recordId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    recordData = {...recordData, ...payload};
    alert("‚úÖ Information updated successfully");

  }catch(err){ console.error(err); alert("Error updating record."); }
};

// ---------------- DOWNLOAD SLIP ----------------
downloadPDFBtn.onclick = () => {
  if(!recordData) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;

  doc.setFontSize(16);
  doc.text("CHO INDEXING SLIP", 105, y, { align: "center" });
  y += 10;

  // Passport
  if(recordData.PASSPORT){
    doc.addImage(recordData.PASSPORT, "JPEG", 80, y, 50, 50);
    y += 60;
  }

  const keysOrder = ["SURNAME","FIRSTNAME","OTHERNAMES","BLOOD_GROUP","OLEVEL_TYPE","GENDER","STATE","LGA_CITY_TOWN","DATE_OF_BIRTH","OLEVEL_YEAR","OLEVEL_EXAM_NUMBER","ALEVEL_TYPE","ALEVEL_YEAR","ENGLISH","MATHEMATICS","BIOLOGY","CHEMISTRY","PHYSICS","REMARKS"];

  keysOrder.forEach(k => {
    if(recordData[k]){
      doc.setFontSize(11);
      doc.text(`${k.replace(/_/g," ")}: ${recordData[k]}`, 15, y);
      y += 7;
      if(y > 280){ doc.addPage(); y = 20; }
    }
  });

  doc.save(`CHO_${recordData.SURNAME}_SLIP.pdf`);
};

});
</script>

</body>
</html>