<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CHO INDEXING FORM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.6.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<h2>CHO INDEXING DATA COLLECTION</h2>

<!-- ---------------- Search Section ---------------- -->
<h3>üîç Find Your Submission</h3>
<input id="searchSurname" placeholder="SURNAME" required>
<select id="searchBloodGroup" required>
  <option value="">SELECT BLOOD GROUP</option>
  <option value="A+">A+</option>
  <option value="A-">A-</option>
  <option value="B+">B+</option>
  <option value="B-">B-</option>
  <option value="AB+">AB+</option>
  <option value="AB-">AB-</option>
  <option value="O+">O+</option>
  <option value="O-">O-</option>
</select>
<select id="searchOlevelType" required>
  <option value="">SELECT O-LEVEL TYPE</option>
  <option value="WAEC">WAEC</option>
  <option value="NECO">NECO</option>
  <option value="NABTEB">NABTEB</option>
  <option value="WAEC / WAEC">WAEC / WAEC</option>
  <option value="NECO / NECO">NECO / NECO</option>
  <option value="NABTEB / NABTEB">NABTEB / NABTEB</option>
  <option value="WAEC / NECO">WAEC / NECO</option>
  <option value="NABTEB / WAEC">NABTEB / WAEC</option>
  <option value="NABTEB / NECO">NABTEB / NECO</option>
</select>
<button type="button" id="searchBtn">Find My Record</button>
<div id="searchWarning" style="color:red;margin-top:5px;"></div>

<!-- ---------------- Form Section ---------------- -->
<form id="indexForm" enctype="multipart/form-data" style="margin-top:20px;">

  <input name="surname" placeholder="SURNAME" required>
  <input name="firstname" placeholder="FIRSTNAME" required>
  <input name="othernames" placeholder="OTHERNAMES">

  <label>PASSPORT (JPG / PNG, Max 5MB)</label>
  <input type="file" id="passport" accept="image/jpeg,image/png">

  <input name="cadre" value="CHO" readonly>

  <select name="gender" required>
    <option value="">SELECT GENDER</option>
    <option value="MALE">MALE</option>
    <option value="FEMALE">FEMALE</option>
  </select>

  <select name="bloodgroup" required>
    <option value="">SELECT BLOOD GROUP</option>
    <option value="A+">A+</option>
    <option value="A-">A-</option>
    <option value="B+">B+</option>
    <option value="B-">B-</option>
    <option value="AB+">AB+</option>
    <option value="AB-">AB-</option>
    <option value="O+">O+</option>
    <option value="O-">O-</option>
  </select>

  <input name="state" placeholder="STATE">
  <input name="lga_city_town" placeholder="LGA / CITY/TOWN">

  <label>DATE OF BIRTH</label>
  <input type="date" name="dob" required>

  <select name="olevel_type" required>
    <option value="">SELECT O-LEVEL TYPE</option>
    <option value="WAEC">WAEC</option>
    <option value="NECO">NECO</option>
    <option value="NABTEB">NABTEB</option>
    <option value="WAEC / WAEC">WAEC / WAEC</option>
    <option value="NECO / NECO">NECO / NECO</option>
    <option value="NABTEB / NABTEB">NABTEB / NABTEB</option>
    <option value="WAEC / NECO">WAEC / NECO</option>
    <option value="NABTEB / WAEC">NABTEB / WAEC</option>
    <option value="NABTEB / NECO">NABTEB / NECO</option>
  </select>

  <input name="olevel_year" placeholder="O-LEVEL YEAR(S)">
  <input name="olevel_exam" placeholder="O-LEVEL EXAM NUMBER">

  <input name="alevel_type" placeholder="A-LEVEL TYPE">
  <input name="alevel_year" placeholder="A-LEVEL YEAR">
  <input name="pro_cert" placeholder="PROFESSIONAL CERTIFICATE NUMBER">

  <!-- Subjects -->
  <input id="engGrade" placeholder="ENGLISH GRADE" required>
  <select id="engBody">
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
  </select>

  <input id="mathGrade" placeholder="MATHEMATICS GRADE" required>
  <select id="mathBody">
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
  </select>

  <input id="bioGrade" placeholder="BIOLOGY GRADE">
  <select id="bioBody">
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
  </select>

  <input id="chemGrade" placeholder="CHEMISTRY GRADE">
  <select id="chemBody">
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
  </select>

  <input id="phyGrade" placeholder="PHYSICS GRADE">
  <select id="phyBody">
    <option>WAEC</option>
    <option>NECO</option>
    <option>NABTEB</option>
  </select>

  <input name="remarks" placeholder="REMARKS">

  <button type="submit">SUBMIT / UPDATE</button>

  <button type="button" id="downloadPDFBtn" style="margin-top:10px;background:#4caf50;color:#fff;">
    Download My Submission PDF
  </button>

  <button type="button" id="adminLoginBtn" style="margin-top:10px;background:#333;color:#fff;">
    Admin Login
  </button>

  <button type="button" id="downloadZipBtn" style="margin-top:10px;display:none;">
    Download All Passports (ZIP)
  </button>

  <div id="previewContainer" style="margin:15px 0;text-align:center;"></div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const SHEETBEST_URL = "https://api.sheetbest.com/sheets/ceb9eddc-af9a-473a-9a32-f52c21c7f72b";
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpsbwjw83/image/upload";
  const CLOUDINARY_PRESET = "cho_passports";
  const ADMIN_PASSWORD = "CHO@2026Secure!";

  const form = document.getElementById("indexForm");
  const submitBtn = form.querySelector("button[type='submit']");
  const downloadPDFBtn = document.getElementById("downloadPDFBtn");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const downloadZipBtn = document.getElementById("downloadZipBtn");
  const previewContainer = document.getElementById("previewContainer");

  let passportDataUrl = "";

  // ---------------- Passport Preview ----------------
  document.getElementById("passport").addEventListener("change", function () {
    previewContainer.innerHTML = "";
    const file = this.files[0];
    if(!file) return;
    if(!["image/jpeg","image/png"].includes(file.type)){ alert("Only JPG/PNG allowed."); this.value=""; return;}
    if(file.size>5*1024*1024){ alert("Max 5MB"); this.value=""; return;}
    const img=document.createElement("img");
    img.style.maxWidth="150px"; img.style.borderRadius="8px"; img.style.boxShadow="0 4px 15px rgba(0,0,0,0.15)";
    img.onload=()=>{ const canvas=document.createElement("canvas"); canvas.width=img.naturalWidth; canvas.height=img.naturalHeight; canvas.getContext("2d").drawImage(img,0,0); passportDataUrl=canvas.toDataURL("image/jpeg"); };
    img.src=URL.createObjectURL(file);
    previewContainer.appendChild(img);
  });

  // ---------------- PDF Download ----------------
  downloadPDFBtn.addEventListener("click", ()=>{
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    let y=20;
    doc.setFontSize(18); doc.text("CHO Indexing Form",105,y,{align:"center"}); y+=10;
    if(passportDataUrl){ doc.addImage(passportDataUrl,"JPEG",80,y,50,50); y+=60; }
    doc.setFontSize(12);
    const fields=[
      ["SURNAME", form.surname.value.toUpperCase()],
      ["FIRSTNAME", form.firstname.value.toUpperCase()],
      ["OTHERNAMES", form.othernames.value.toUpperCase()],
      ["CADRE", form.cadre.value],
      ["GENDER", form.gender.value],
      ["BLOOD GROUP", form.bloodgroup.value],
      ["STATE", form.state.value],
      ["LGA / CITY/TOWN", form.lga_city_town.value],
      ["DATE OF BIRTH", form.dob.value],
      ["O-LEVEL TYPE", form.olevel_type.value],
      ["O-LEVEL YEAR", form.olevel_year.value],
      ["O-LEVEL EXAM NO.", form.olevel_exam.value],
      ["A-LEVEL TYPE", form.alevel_type.value],
      ["A-LEVEL YEAR", form.alevel_year.value],
      ["PROFESSIONAL CERT. NO.", form.pro_cert.value],
      ["ENGLISH", `${document.getElementById("engGrade").value} (${document.getElementById("engBody").value})`],
      ["MATHEMATICS", `${document.getElementById("mathGrade").value} (${document.getElementById("mathBody").value})`],
      ["BIOLOGY", document.getElementById("bioGrade").value ? `${document.getElementById("bioGrade").value} (${document.getElementById("bioBody").value})`:""],
      ["CHEMISTRY", document.getElementById("chemGrade").value ? `${document.getElementById("chemGrade").value} (${document.getElementById("chemBody").value})`:""],
      ["PHYSICS", document.getElementById("phyGrade").value ? `${document.getElementById("phyGrade").value} (${document.getElementById("phyBody").value})`:""],
      ["REMARKS", form.remarks.value]
    ];
    fields.forEach(([label,value])=>{ doc.text(`${label}: ${value}`,20,y); y+=8; if(y>280){doc.addPage();y=20;}});
    doc.save(`CHO_Form_${form.surname.value}.pdf`);
  });

  // ---------------- Admin Access ----------------
  function requireAdminAccess(){ const entered=prompt("üîí Admin Password:"); if(entered!==ADMIN_PASSWORD){alert("‚ùå Access Denied"); return false;} return true; }
  adminLoginBtn.addEventListener("click",()=>{ if(requireAdminAccess()){downloadZipBtn.style.display="inline-block"; adminLoginBtn.style.display="none"; alert("‚úÖ Admin access granted"); }});

  // ---------------- Bulk ZIP Download ----------------
  downloadZipBtn.addEventListener("click", async ()=>{
    if(!requireAdminAccess()) return;
    downloadZipBtn.disabled=true; downloadZipBtn.innerText="Preparing ZIP...";
    try{
      const res=await fetch(SHEETBEST_URL);
      const allData=await res.json();
      const zip=new JSZip(); const imgFolder=zip.folder("passports");
      for(let i=0;i<allData.length;i++){const r=allData[i]; if(r.PASSPORT){const blob=await (await fetch(r.PASSPORT)).blob(); imgFolder.file(`${r.SURNAME}_${r.FIRSTNAME}_${i+1}.jpg`,blob);}}
      const content=await zip.generateAsync({type:"blob"}); const a=document.createElement("a"); a.href=URL.createObjectURL(content); a.download="CHO_Passports.zip"; a.click();
    }catch(err){alert("Failed to create ZIP"); console.error(err);}
    finally{downloadZipBtn.disabled=false; downloadZipBtn.innerText="Download All Passports (ZIP)";}
  });

  // ---------------- Search & Edit Existing ----------------
  document.getElementById("searchBtn").addEventListener("click", async ()=>{
    const s=document.getElementById("searchSurname").value.trim().toUpperCase();
    const b=document.getElementById("searchBloodGroup").value;
    const o=document.getElementById("searchOlevelType").value;
    const warning=document.getElementById("searchWarning");
    if(!s||!b||!o){ warning.textContent="Please fill all fields to search."; return; }
    try{
      const res=await fetch(SHEETBEST_URL);
      const allData=await res.json();
      const record=allData.find(r=>r.SURNAME===s && r.BLOOD_GROUP===b && r.OLEVEL_TYPE===o);
      if(!record){ warning.textContent="‚ùå Record not found!"; return; }
      warning.textContent="‚úÖ Record found! You can edit now.";
      
      // Pre-fill form
      form.surname.value=record.SURNAME;
      form.firstname.value=record.FIRSTNAME || "";
      form.othernames.value=record.OTHERNAMES || "";
      form.gender.value=record.GENDER || "";
      form.bloodgroup.value=record.BLOOD_GROUP || "";
      form.state.value=record.STATE || "";
      form.lga_city_town.value=record.LGA_CITY_TOWN || "";
      form.dob.value=record.DATE_OF_BIRTH || "";
      form.olevel_type.value=record.OLEVEL_TYPE || "";
      form.olevel_year.value=record.OLEVEL_YEAR || "";
      form.olevel_exam.value=record.OLEVEL_EXAM_NUMBER || "";
      form.alevel_type.value=record.ALEVEL_TYPE || "";
      form.alevel_year.value=record.ALEVEL_YEAR || "";
      form.pro_cert.value=record.PROFESSIONAL_CERTIFICATE_NUMBER || "";
      document.getElementById("engGrade").value=record.ENGLISH?.split(" ")[0]||"";
      document.getElementById("engBody").value=record.ENGLISH?.match(/ÓÄÅ([^)]+)ÓÄÅ/)?.[1]||"";
      document.getElementById("mathGrade").value=record.MATHEMATICS?.split(" ")[0]||"";
      document.getElementById("mathBody").value=record.MATHEMATICS?.match(/ÓÄÅ([^)]+)ÓÄÅ/)?.[1]||"";
      document.getElementById("bioGrade").value=record.BIOLOGY?.split(" ")[0]||"";
      document.getElementById("bioBody").value=record.BIOLOGY?.match(/ÓÄÅ([^)]+)ÓÄÅ/)?.[1]||"";
      document.getElementById("chemGrade").value=record.CHEMISTRY?.split(" ")[0]||"";
      document.getElementById("chemBody").value=record.CHEMISTRY?.match(/ÓÄÅ([^)]+)ÓÄÅ/)?.[1]||"";
      document.getElementById("phyGrade").value=record.PHYSICS?.split(" ")[0]||"";
      document.getElementById("phyBody").value=record.PHYSICS?.match(/ÓÄÅ([^)]+)ÓÄÅ/)?.[1]||"";
      form.remarks.value=record.REMARKS || "";
      if(record.PASSPORT){ const img=document.createElement("img"); img.src=record.PASSPORT; img.style.maxWidth="150px"; previewContainer.innerHTML=""; previewContainer.appendChild(img); passportDataUrl=record.PASSPORT; }
    }catch(err){ console.error(err); warning.textContent="‚ùå Error fetching data!"; }
  });

  // ---------------- Form Submit ----------------
  form.addEventListener("submit", async function(e){
    e.preventDefault();
    submitBtn.disabled=true; submitBtn.innerText="Saving data...";
    try{
      const file=document.getElementById("passport").files[0];
      if(file){ if(!["image/jpeg","image/png"].includes(file.type)) throw "Only JPG/PNG allowed"; if(file.size>5*1024*1024) throw "Max 5MB"; }

      const s=form.surname.value.trim().toUpperCase();
      const b=form.bloodgroup.value;
      const o=form.olevel_type.value;

      const res=await fetch(SHEETBEST_URL); const allData=await res.json();
      const duplicateIndex=allData.findIndex(r=>r.SURNAME===s && r.BLOOD_GROUP===b && r.OLEVEL_TYPE===o);

      let passportUrl=passportDataUrl;
      if(file){ 
        const cloudForm=new FormData(); cloudForm.append("file",file); cloudForm.append("upload_preset",CLOUDINARY_PRESET);
        const cloudRes=await fetch(CLOUDINARY_URL,{method:"POST",body:cloudForm});
        if(!cloudRes.ok) throw "Cloud upload failed";
        const cloudData=await cloudRes.json();
        passportUrl=cloud

passportUrl = cloudData.secure_url;
      }

      // Prepare record object
      const recordData = {
        SURNAME: s,
        FIRSTNAME: form.firstname.value.trim().toUpperCase(),
        OTHERNAMES: form.othernames.value.trim().toUpperCase(),
        PASSPORT: passportUrl,
        CADRE: form.cadre.value,
        GENDER: form.gender.value,
        BLOOD_GROUP: b,
        STATE: form.state.value,
        LGA_CITY_TOWN: form.lga_city_town.value,
        DATE_OF_BIRTH: form.dob.value,
        OLEVEL_TYPE: o,
        OLEVEL_YEAR: form.olevel_year.value,
        OLEVEL_EXAM_NUMBER: form.olevel_exam.value,
        ALEVEL_TYPE: form.alevel_type.value,
        ALEVEL_YEAR: form.alevel_year.value,
        PROFESSIONAL_CERTIFICATE_NUMBER: form.pro_cert.value,
        ENGLISH: `${document.getElementById("engGrade").value} (${document.getElementById("engBody").value})`,
        MATHEMATICS: `${document.getElementById("mathGrade").value} (${document.getElementById("mathBody").value})`,
        BIOLOGY: document.getElementById("bioGrade").value ? `${document.getElementById("bioGrade").value} (${document.getElementById("bioBody").value})` : "",
        CHEMISTRY: document.getElementById("chemGrade").value ? `${document.getElementById("chemGrade").value} (${document.getElementById("chemBody").value})` : "",
        PHYSICS: document.getElementById("phyGrade").value ? `${document.getElementById("phyGrade").value} (${document.getElementById("phyBody").value})` : "",
        REMARKS: form.remarks.value
      };

      // If record exists, update via PUT/PATCH
      let response;
      if(duplicateIndex !== -1){
        const existingRecord = allData[duplicateIndex];
        response = await fetch(`${SHEETBEST_URL}/${existingRecord.id}`, { // Assuming Sheetbest assigns "id" to each row
          method: "PUT",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(recordData)
        });
      } else {
        // Otherwise create new
        response = await fetch(SHEETBEST_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify([recordData])
        });
      }

      if(!response.ok) throw "Failed to save record";

      form.innerHTML = `
        <div style="text-align:center;padding:40px">
          <h2 style="color:#2ecc71">‚úÖ Submission Successful</h2>
          <p>Your information has been saved successfully.</p>
          <p style="color:red;font-weight:bold;">‚ö†Ô∏è Admin will only accept your information after receiving your registration payment.</p>
          <button onclick="location.reload()">Submit / Edit Another</button>
        </div>
      `;
    } catch(err){
      alert(err);
      submitBtn.disabled=false;
      submitBtn.innerText="SUBMIT / UPDATE";
      console.error(err);
    }
  });
});
</script>

</body>
</html>